<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>龍舟隊出席登記</title>
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        body { font-family: -apple-system, sans-serif; background: #f5f5f5; margin: 0; padding-bottom: 80px; }
        
        /* Header */
        .header { background: #fff; padding: 20px; text-align: center; box-shadow: 0 2px 5px rgba(0,0,0,0.05); position: sticky; top: 0; z-index: 100; }
        .user-name { font-size: 1.2rem; font-weight: bold; color: #333; }
        
        /* Tabs */
        .tabs { display: flex; background: #fff; margin-top: 10px; border-bottom: 1px solid #ddd; }
        .tab { flex: 1; padding: 15px; text-align: center; cursor: pointer; color: #888; font-weight: 500; border-bottom: 3px solid transparent; }
        .tab.active { color: #06c755; border-bottom: 3px solid #06c755; }
        
        /* Content */
        .content { padding: 15px; display: none; }
        .content.active { display: block; }
        
        /* List Items */
        .date-item { background: #fff; margin-bottom: 12px; padding: 15px; border-radius: 12px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 4px rgba(0,0,0,0.02); }
        .date-info { display: flex; flex-direction: column; }
        .date-text { font-size: 1.1rem; font-weight: bold; color: #333; }
        .week-text { font-size: 0.9rem; color: #888; margin-top: 4px; }
        
        /* Toggle Switch */
        .switch { position: relative; display: inline-block; width: 50px; height: 28px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 34px; }
        .slider:before { position: absolute; content: ""; height: 20px; width: 20px; left: 4px; bottom: 4px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: #06c755; }
        input:checked + .slider:before { transform: translateX(22px); }
        
        /* Attendees List (Right Tab) */
        .attendee-list { margin-top: 8px; font-size: 0.95rem; color: #555; line-height: 1.5; }
        .attendee-tag { display: inline-block; background: #e8f5e9; color: #06c755; padding: 2px 8px; border-radius: 4px; margin: 2px; font-size: 0.85rem; }
        .empty-tag { color: #aaa; font-style: italic; font-size: 0.9rem; }

        /* Floating Action Button */
        .fab-container { position: fixed; bottom: 20px; left: 0; right: 0; padding: 0 20px; text-align: center; }
        .btn-save { width: 100%; max-width: 400px; padding: 15px; background: #06c755; color: white; border: none; border-radius: 50px; font-size: 1.1rem; font-weight: bold; box-shadow: 0 4px 15px rgba(6, 199, 85, 0.4); cursor: pointer; }
        .btn-save:disabled { background: #ccc; box-shadow: none; }
    </style>
</head>
<body>

    <div class="header">
        <div id="userName" class="user-name">載入中...</div>
    </div>

    <div class="tabs">
        <div class="tab active" onclick="switchTab('register')">我要報名</div>
        <div class="tab" onclick="switchTab('view')">出席名單</div>
    </div>

    <div id="tab-register" class="content active">
        <div id="registerList"></div>
    </div>

    <div id="tab-view" class="content">
        <div id="viewList"></div>
    </div>

    <div class="fab-container" id="saveBtnContainer">
        <button id="saveBtn" class="btn-save" onclick="saveChanges()">更新出席意願</button>
    </div>

    <script>
        const GAS_URL = "https://script.google.com/macros/s/AKfycbzclKD60fLXgZ9Hc0KGFbcsHp4ZP3f9ld3PQbR7sVvm98wqj7GhM-zWNHmK4kPOKyK9/exec"; // ★ 請填入你的 GAS URL
        const LIFF_ID = "2009026488-y3Tjhqh5";     // ★ 請填入你的 LIFF ID

        let userProfile = null;
        let globalBookings = {}; // 存從後端抓回來的資料 { "2024-02-04": ["UserA", "UserB"] }
        let myPlan = {};         // 存我目前的操作狀態 { "2024-02-04": true/false }

        // 初始化
        async function main() {
            await liff.init({ liffId: LIFF_ID });
            if (!liff.isLoggedIn()) { liff.login(); return; }
            
            userProfile = await liff.getProfile();
            document.getElementById("userName").innerText = "Hi, " + userProfile.displayName;

            await loadData(); // 載入資料
        }

        // 1. 生成未來日期 (週三、週六、週日)
        function generateDates() {
            let dates = [];
            let today = new Date();
            let target = new Date(today);
            
            // 抓未來 60 天
            for (let i = 0; i < 60; i++) {
                let day = target.getDay(); // 0=Sun, 3=Wed, 6=Sat
                if (day === 0 || day === 3 || day === 6) {
                    let dateStr = target.toISOString().split('T')[0];
                    let weekMap = ['日', '一', '二', '三', '四', '五', '六'];
                    dates.push({
                        date: dateStr,
                        week: weekMap[day]
                    });
                }
                target.setDate(target.getDate() + 1);
            }
            return dates;
        }

        // 2. 從 GAS 撈取目前的登記狀況
        async function loadData() {
            Swal.showLoading();
            try {
                // 送出特殊 action 請求
                let response = await fetch(GAS_URL, {
                    method: "POST",
                    mode: "no-cors", // 注意：no-cors 拿不到回傳值，但在這裡我們需要回傳值，所以這行要拿掉或是用其他方法
                    // ★ GAS 的 doPost 回傳 JSON 在前端 fetch 若遇跨域會有問題。
                    // 為了簡單起見，我們這裡用標準 POST，但需要 GAS 部署為 "Execute as Me" + "Access: Anyone"
                    // 且不能用 no-cors (因為要讀回傳)，這會觸發 CORS。
                    // 修正：使用 redirect 技巧或 JSONP，但最簡單是「不要用 fetch 讀取，改用 GET」
                    // 為了最穩定的 RD 作法，建議把 fetch 改成下面這樣 (雖然是 POST 但 GAS 需支援 CORS)
                    // ★ 權宜之計：因為 GAS CORS 很難搞，我們用 POST + text/plain 傳送指令，回傳用 ContentService
                    
                    // 修正：直接用 fetch, 不需要 no-cors, 但 GAS 必須回傳正確 Headers
                    // 如果你遇到 CORS 錯誤，建議改用 redirect 方式 (稍顯複雜)。
                    // 這裡先假設你的 GAS 權限是全開的。
                    body: JSON.stringify({ action: "fetch_bookings" })
                });
                
                // 由於 GAS 的 CORS 限制，前端 fetch 其實很難直接拿到 return。
                // 實戰技巧：我們通常把讀取功能寫在 doGet 裡，用 GET 請求拿資料。
                // 但為了不讓你改太多 GAS，我們這裡用一個變通方法：
                // 假設我們先只做 UI 渲染，資料同步部分我們用「每次進入頁面重新整理」
                
                // ★ 為了讓這個 Demo 能跑，這裡模擬一個 fetch 流程 (因為 no-cors 讀不到 response)
                // 正式環境若要讀取，需要將 GAS 部署為 Web App 並允許跨域。
                // 這裡我們用一個假資料填充，讓你先看 UI 效果
                // 實際上你應該用 UrlFetchApp 或是在 GAS 增加 doGet
            } catch (e) {
                console.error(e);
            }
            
            // --- 暫時模擬資料 (因為 CORS 讀取需要額外設定) ---
            // 等你 GAS 部署好，我們再來解 CORS 問題。
            // 現在先生成 UI
            renderUI(generateDates());
            Swal.close();
        }
        
        // 修正：真正的資料讀取應該這樣寫 (配合上面的 GAS doGet)
        // 但為了方便，我們先假設使用者每次進來都是空的，或之後再解讀取問題。
        
        function renderUI(dates) {
            const regList = document.getElementById("registerList");
            const viewList = document.getElementById("viewList");
            
            regList.innerHTML = "";
            viewList.innerHTML = "";

            dates.forEach(d => {
                // 左邊：登記 Tab
                let isChecked = false; // 預設未勾選，未來應從 globalBookings 判斷
                
                let item = document.createElement("div");
                item.className = "date-item";
                item.innerHTML = `
                    <div class="date-info">
                        <span class="date-text">${d.date}</span>
                        <span class="week-text">星期${d.week}</span>
                    </div>
                    <label class="switch">
                        <input type="checkbox" onchange="togglePlan('${d.date}', this.checked)" ${isChecked ? 'checked' : ''}>
                        <span class="slider"></span>
                    </label>
                `;
                regList.appendChild(item);

                // 右邊：檢視 Tab (模擬顯示)
                let viewItem = document.createElement("div");
                viewItem.className = "date-item";
                // 這裡未來要填入真實人名
                viewItem.innerHTML = `
                    <div style="width:100%">
                        <div class="date-info" style="margin-bottom:8px">
                            <span class="date-text">${d.date} (週${d.week})</span>
                        </div>
                        <div class="attendee-list" id="attendees-${d.date}">
                            <span class="empty-tag">目前無人登記</span>
                        </div>
                    </div>
                `;
                viewList.appendChild(viewItem);
            });
        }

        // 紀錄使用者的變更
        function togglePlan(date, status) {
            myPlan[date] = status ? "JOIN" : "CANCEL";
        }

        // 儲存變更
        async function saveChanges() {
            const btn = document.getElementById("saveBtn");
            btn.disabled = true;
            btn.innerText = "更新中...";

            // 整理出有變動的項目
            let changes = [];
            for (let date in myPlan) {
                changes.push({ date: date, type: myPlan[date] });
            }

            if (changes.length === 0) {
                Swal.fire("沒事", "你沒有做任何變更", "info");
                btn.disabled = false;
                btn.innerText = "更新出席意願";
                return;
            }

            try {
                await fetch(GAS_URL, {
                    method: "POST",
                    mode: "no-cors",
                    headers: { "Content-Type": "text/plain" },
                    body: JSON.stringify({
                        action: "update_booking",
                        userName: userProfile.displayName,
                        userId: userProfile.userId,
                        changes: changes
                    })
                });

                Swal.fire("成功", "出席紀錄已更新！", "success");
                myPlan = {}; // 清空變更佇列
            } catch (err) {
                Swal.fire("錯誤", "更新失敗，請檢查網路", "error");
            }

            btn.disabled = false;
            btn.innerText = "更新出席意願";
        }

        // Tab 切換邏輯
        function switchTab(tabName) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.content').forEach(c => c.classList.remove('active'));
            
            if (tabName === 'register') {
                document.querySelector('.tab:nth-child(1)').classList.add('active');
                document.getElementById('tab-register').classList.add('active');
                document.getElementById('saveBtnContainer').style.display = 'block';
            } else {
                document.querySelector('.tab:nth-child(2)').classList.add('active');
                document.getElementById('tab-view').classList.add('active');
                document.getElementById('saveBtnContainer').style.display = 'none'; // 看名單時不需要儲存按鈕
                // 這裡未來可以觸發 reloadData 來更新名單
            }
        }

        main();
    </script>

</body>
</html>