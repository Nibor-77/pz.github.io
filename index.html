<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é¾èˆŸéšŠå ±åˆ°ç³»çµ±</title>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <style>
        body { font-family: sans-serif; text-align: center; padding-top: 50px; }
        .btn { padding: 15px 30px; font-size: 20px; cursor: pointer; background: #00B900; color: white; border: none; border-radius: 5px; display: none; margin: 20px auto; }
        #status { color: #666; margin: 20px; }
    </script>
</head>
<body>
    <h2>ğŸ‰ é¾èˆŸéšŠç·´ç¿’å ±åˆ°</h2>
    <div id="status">æ­£åœ¨è¼‰å…¥ LINE èº«åˆ†...</div>
    <button id="checkInBtn" class="btn">ç¢ºèªå ±åˆ°</button>

    <script>
        const GAS_URL = "https://script.google.com/macros/s/AKfycbwRWWLfn_DXYayKOKXg8iYS34s5RMzjzM4ozQcdS0wUYIvuEZjV5K4R2Gb2W8GOQbI/exec"; // è²¼ä¸Šå‰›å‰›éƒ¨ç½²å®Œçš„ exec ç¶²å€
        const LIFF_ID = "ä½ çš„_LIFF_ID";     // è²¼ä¸Š LINE Developers çš„ LIFF ID

        async function init() {
            try {
                await liff.init({ liffId: LIFF_ID });
                if (!liff.isLoggedIn()) {
                    liff.login();
                } else {
                    const profile = await liff.getProfile();
                    document.getElementById("status").innerText = "éšŠå‹æ‚¨å¥½ï¼š" + profile.displayName;
                    const btn = document.getElementById("checkInBtn");
                    btn.style.display = "block";

                    btn.onclick = async () => {
                        btn.disabled = true;
                        btn.innerText = "å‚³é€ä¸­...";
                        
                        // å˜—è©¦ç²å–ä½ç½®ï¼Œè‹¥å¤±æ•—å‰‡å‚³é€ null
                        let lat = null, lng = null;
                        try {
                            const pos = await new Promise((res, rej) => {
                                navigator.geolocation.getCurrentPosition(res, rej, {timeout: 5000});
                            });
                            lat = pos.coords.latitude;
                            lng = pos.coords.longitude;
                        } catch (e) {
                            console.log("ç„¡æ³•ç²å–ä½ç½®");
                        }

                        // å‚³é€åˆ°å¾Œç«¯ GAS
                        await fetch(GAS_URL, {
                            method: "POST",
                            mode: "no-cors", // é¿å…è·¨ç¶²åŸŸéŒ¯èª¤
                            body: JSON.stringify({
                                userName: profile.displayName,
                                userId: profile.userId,
                                lat: lat,
                                lng: lng
                            })
                        });

                        alert("æ‰“å¡æˆåŠŸï¼æ™‚é–“å·²ç´€éŒ„ã€‚");
                        liff.closeWindow();
                    };
                }
            } catch (err) {
                document.getElementById("status").innerText = "éŒ¯èª¤: " + err.message;
            }
        }
        init();
    </script>
</body>
</html>
