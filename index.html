<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ´¾å…œæ‰“å¡ç³»çµ±</title>
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; text-align: center; background: #f0f2f5; padding-top: 40px; }
        .container { background: white; width: 85%; max-width: 400px; margin: auto; padding: 30px 20px; border-radius: 20px; box-shadow: 0 4px 20px rgba(0,0,0,0.08); }
        h2 { margin-bottom: 5px; color: #1a1a1a; font-weight: 700; }
        #status { color: #666; margin-bottom: 25px; font-size: 0.9rem; }
        
        /* æŒ‰éˆ•æ¨£å¼ */
        .btn { padding: 16px 0; width: 100%; font-size: 1.1rem; cursor: pointer; background: #06c755; color: white; border: none; border-radius: 12px; display: none; font-weight: bold; letter-spacing: 1px; transition: all 0.2s; }
        .btn:active { background: #05a546; transform: scale(0.98); }
        .btn:disabled { background: #ccc; cursor: not-allowed; transform: none; }
        
        /* è®€å–å‹•ç•« */
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.6; } 100% { opacity: 1; } }
        .loading { animation: pulse 1.5s infinite; }
    </style>
</head>
<body>
    <div class="container">
        <h2 id="msg">èº«åˆ†ç¢ºèªä¸­...</h2>
        <div id="status">æ­£åœ¨é€£çµç³»çµ±</div>
        <button id="checkInBtn" class="btn">ç¢ºèªå‡ºå¸­</button>
    </div>

    <script>
        // ================= è¨­å®šå€ (è«‹åœ¨æ­¤å¡«å…¥è³‡æ–™) =================
        const GAS_URL = "https://script.google.com/macros/s/AKfycbxfU_nYKww5-NdxIBQmywCuEfhWJhEABYhMkUFrSBcQu_WWiEpJt_3kZ3OkRUHOEu42/exec"; // å‹™å¿…ç¢ºèªçµå°¾æ˜¯ /exec
        const LIFF_ID = "2009026488-y3Tjhqh5";
        
        // åœ°é»ï¼šå¤§ä½³æ²³æ¿±é¾èˆŸç¢¼é ­
        const TARGET_LAT = 25.0756925;
        const TARGET_LNG = 121.5443535;
        const ALLOWED_RADIUS = 500; // å…è¨±åŠå¾‘ (å…¬å°º)
        // ========================================================

        // --- ğŸ² éš¨æ©Ÿæ–‡æ¡ˆåº« ---
        
        // æƒ…å¢ƒ Aï¼šæˆåŠŸæŠµé” (å‹µå¿—/ç†±è¡€)
        const successMsgs = [
            "ä»Šå¤©çš„ä½ ï¼Œæ°£å ´å…©ç±³å…«ï¼åˆ’èµ·ä¾†ï¼ğŸ’ª",
            "æ—¢ç„¶ä¾†äº†ï¼Œå°±åˆ’çˆ†å®ƒï¼GOGOGOï¼",
            "ä½ çš„è‚Œè‚‰åœ¨å‘¼å–šä½ ï¼Œå¿«å»ç†±èº«ï¼ğŸ”¥",
            "è½èªªä»Šå¤©æ°´æ³ä¸éŒ¯ï¼Œç ´å€‹ç´€éŒ„å§ï¼Ÿ",
            "èªçœŸåˆ’èˆ¹çš„äººæœ€å¸¥/æœ€ç¾ï¼ğŸ˜",
            "é¾èˆŸé­‚ç‡ƒç‡’ï¼æŠŠæ°´é¢ç‚¸é–‹å§ï¼",
            "é¢¨é›¨ç„¡é˜»ï¼Œé€™å°±æ˜¯é¾èˆŸç²¾ç¥ï¼",
            "ä¸è¦å•ï¼Œåˆ’å°±å°äº†ï¼"
        ];

        // æƒ…å¢ƒ Bï¼šè·é›¢å¤ªé  (å˜²è«·/é˜²å¼Š)
        const errorMsgs = [
            "ä¸è¦ç•¶åˆ’èˆ¹é¨™å­ï¼ğŸ˜¡",
            "ä½ æ˜¯åœ¨å¤¢è£¡åˆ’èˆ¹å—ï¼Ÿé†’é†’ï¼ğŸ˜´",
            "é€™å€‹è·é›¢...ä½ æ˜¯æƒ³ç”¨æ„å¿µåˆ’èˆ¹ï¼ŸğŸ§ ",
            "é€™è£¡çœ‹ä¸åˆ°æ²³ï¼Œåªçœ‹å¾—åˆ°ä½ çš„è—‰å£ã€‚ğŸ‘€",
            "é¨™éäº†ç³»çµ±ï¼Œé¨™ä¸éæ•™ç·´çš„çœ¼ç›ã€‚",
            "é™¤éä½ æœƒç¬é–“ç§»å‹•ï¼Œä¸ç„¶é€™è·é›¢ä¸ç§‘å­¸ã€‚ğŸ›¸",
            "èª å¯¦æ˜¯ç¾å¾·ï¼Œè·é›¢æ˜¯ç¾å¯¦ã€‚ğŸ“",
            "æ•™ç·´åœ¨ä½ èƒŒå¾Œï¼Œä»–ç¾åœ¨éå¸¸ç«ã€‚ğŸ”¥"
        ];

        // --- å·¥å…·å‡½å¼ ---
        
        function getRandomText(arr) {
            return arr[Math.floor(Math.random() * arr.length)];
        }

        // Haversine å…¬å¼è¨ˆç®—è·é›¢ (å›å‚³å…¬å°º)
        function getDistanceFromLatLonInKm(lat1, lon1, lat2, lon2) {
            var R = 6371; 
            var dLat = deg2rad(lat2 - lat1);
            var dLon = deg2rad(lon2 - lon1);
            var a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                    Math.cos(deg2rad(lat1)) * Math.cos(deg2rad(lat2)) *
                    Math.sin(dLon / 2) * Math.sin(dLon / 2);
            var c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
            return R * c * 1000;
        }
        function deg2rad(deg) { return deg * (Math.PI / 180); }

        function getPosition() {
            return new Promise((resolve, reject) => {
                if (!navigator.geolocation) { reject(new Error("ä¸æ”¯æ´å®šä½")); return; }
                navigator.geolocation.getCurrentPosition(resolve, reject, {
                    enableHighAccuracy: true, timeout: 8000, maximumAge: 0
                });
            });
        }

        // --- ä¸»ç¨‹å¼é‚è¼¯ ---
        async function main() {
            try {
                // 1. åˆå§‹åŒ– LIFF
                await liff.init({ liffId: LIFF_ID });
                if (!liff.isLoggedIn()) { liff.login(); return; }

                const profile = await liff.getProfile();
                document.getElementById("msg").innerText = profile.displayName;
                document.getElementById("status").innerText = "æ­¡è¿åƒåŠ ç·´ç¿’ï¼";
                
                const btn = document.getElementById("checkInBtn");
                btn.style.display = "block";

                // 2. æŒ‰éˆ•é»æ“Šäº‹ä»¶
                btn.onclick = async () => {
                    btn.disabled = true;
                    btn.innerText = "å®šä½èˆ‡åˆ¤æ–·ä¸­...";
                    btn.classList.add("loading");
                    
                    let lat = null, lng = null;
                    let distance = 0;
                    let isNearby = false;

                    // 3. ç²å–ä½ç½®
                    try {
                        const position = await getPosition();
                        lat = position.coords.latitude;
                        lng = position.coords.longitude;
                        
                        // è¨ˆç®—è·é›¢
                        distance = getDistanceFromLatLonInKm(lat, lng, TARGET_LAT, TARGET_LNG);
                        isNearby = distance <= ALLOWED_RADIUS;
                    } catch (err) {
                        console.warn("å®šä½å¤±æ•—æˆ–è¶…æ™‚");
                    }

                    // 4. å‚³é€è³‡æ–™åˆ° GAS (ä¸ç®¡è·é›¢å¤šé éƒ½å‚³ï¼Œç•™å­˜ç´€éŒ„)
                    try {
                        await fetch(GAS_URL, {
                            method: "POST",
                            mode: "no-cors", 
                            headers: { "Content-Type": "text/plain" },
                            body: JSON.stringify({
                                userName: profile.displayName,
                                userId: profile.userId,
                                lat: lat,
                                lng: lng
                            })
                        });

                        // 5. æ ¹æ“šçµæœå½ˆå‡ºä¸åŒè¦–çª—
                        if (lat && isNearby) {
                            // âœ… æˆåŠŸä¸”åœ¨ç¯„åœå…§
                            const randomMsg = getRandomText(successMsgs);
                            Swal.fire({
                                title: 'æ‰“å¡æˆåŠŸï¼',
                                html: `è·é›¢ç¢¼é ­ ${Math.round(distance)} å…¬å°º<br><br><b>${randomMsg}</b>`,
                                icon: 'success',
                                confirmButtonText: 'æ”¶åˆ°',
                                confirmButtonColor: '#06c755'
                            }).then(() => liff.closeWindow());

                        } else if (lat && !isNearby) {
                            // âŒ æˆåŠŸä½†å¤ªé 
                            const randomMsg = getRandomText(errorMsgs);
                            Swal.fire({
                                title: 'è·é›¢å¤ªé å›‰ï¼',
                                html: `ç›®å‰è·é›¢ç¢¼é ­ <b>${Math.round(distance)}</b> å…¬å°º<br><br><span style="color:#d33; font-weight:bold">${randomMsg}</span>`,
                                icon: 'error',
                                confirmButtonText: 'æˆ‘å»é¢å£',
                                confirmButtonColor: '#d33'
                            }).then(() => liff.closeWindow());

                        } else {
                            // âš ï¸ æ²’é–‹å®šä½
                            Swal.fire({
                                title: 'æ‰“å¡æˆåŠŸ',
                                text: 'âš ï¸ ç„¡æ³•ç¢ºèªè·é›¢ (æœªé–‹å•Ÿå®šä½)\nè«‹ç¢ºèªæ˜¯å¦é–‹å•Ÿ GPS',
                                icon: 'warning',
                                confirmButtonColor: '#f8bb86'
                            }).then(() => liff.closeWindow());
                        }

                    } catch (err) {
                        Swal.fire('é€£ç·šéŒ¯èª¤', 'è«‹æª¢æŸ¥ç¶²è·¯å¾Œé‡è©¦', 'error');
                        btn.disabled = false;
                        btn.innerText = "é‡æ–°æ‰“å¡";
                        btn.classList.remove("loading");
                    }
                };
            } catch (error) {
                Swal.fire("ç³»çµ±éŒ¯èª¤", "ç„¡æ³•è¼‰å…¥ LIFF\n" + error.message, "error");
            }
        }
        main();
    </script>
</body>
</html>
